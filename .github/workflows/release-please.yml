name: Release Please

# Creates release PRs and GitHub releases automatically based on conventional commits
#
# REQUIRED SETUP:
# 1. Go to Settings â†’ Actions â†’ General â†’ Workflow permissions
# 2. Enable "Allow GitHub Actions to create and approve pull requests"

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
      pr: ${{ steps.release.outputs.pr }}
    steps:
      - uses: actions/checkout@v4

      - uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

      # Note: CI for release PRs is triggered via workflow_run event in ci.yml
      # when this workflow completes, which creates the required 'build' status check

      # Keep release PR up to date with main branch
      # This ensures the PR always includes the latest commits
      - name: Update release PR branch
        if: ${{ steps.release.outputs.pr }}
        continue-on-error: true
        run: |
          PR_NUMBER=$(echo '${{ steps.release.outputs.pr }}' | jq -r '.number')
          if [ -n "$PR_NUMBER" ] && [ "$PR_NUMBER" != "null" ]; then
            echo "Updating PR #$PR_NUMBER branch to include latest main commits"
            gh pr update-branch "$PR_NUMBER" --rebase || echo "Branch already up to date or update not needed"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Auto-merge the release PR when it's created/updated
      # Note: Requires "Allow auto-merge" enabled in repo settings
      - name: Enable auto-merge for release PR
        if: ${{ steps.release.outputs.prs_created == 'true' }}
        continue-on-error: true
        run: |
          gh pr merge ${{ fromJSON(steps.release.outputs.pr).number }} --auto --squash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Log when a release is created
      - name: Log release
        if: ${{ steps.release.outputs.release_created }}
        run: |
          echo "ðŸŽ‰ Release created!"
          echo "Tag: ${{ steps.release.outputs.tag_name }}"
          echo "Version: ${{ steps.release.outputs.version }}"

      # Workaround: Manually create release if release-please didn't
      # This handles the "untagged, merged release PRs outstanding" case
      - name: Check for and fix stuck releases
        continue-on-error: true
        run: |
          # Find any merged release PRs with pending label
          STUCK_PRS=$(gh pr list --state merged --label "autorelease: pending" --json number,title --jq '.[].number')

          for PR_NUMBER in $STUCK_PRS; do
            echo "Found stuck release PR #$PR_NUMBER"

            # Get version from manifest
            VERSION=$(cat .release-please-manifest.json | jq -r '.["."[]]' 2>/dev/null || cat .release-please-manifest.json | jq -r '."."')

            if [ -n "$VERSION" ] && [ "$VERSION" != "null" ]; then
              TAG="v$VERSION"

              # Check if release already exists
              if ! gh release view "$TAG" &>/dev/null; then
                echo "Creating release $TAG"

                # Get changelog section for this version
                NOTES=$(sed -n "/## \[$VERSION\]/,/## \[/p" CHANGELOG.md | head -n -1)

                if [ -z "$NOTES" ]; then
                  NOTES="Release $TAG"
                fi

                gh release create "$TAG" --title "$TAG" --notes "$NOTES"
              fi

              # Update PR labels
              gh pr edit "$PR_NUMBER" --remove-label "autorelease: pending" --add-label "autorelease: tagged"
              echo "Fixed PR #$PR_NUMBER"
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Deploy when a release is created
  # This is the ONLY way deploys happen automatically (besides manual workflow_dispatch)
  deploy-on-release:
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    uses: ./.github/workflows/deploy.yml
    secrets: inherit
